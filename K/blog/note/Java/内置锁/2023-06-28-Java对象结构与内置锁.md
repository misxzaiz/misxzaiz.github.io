# Java对象结构与内置锁

Java内置锁的很多重要信息都存放在对象结构中。作为铺垫，在介绍Java内置锁之前，先为大家介绍一下Java对象结构。

## 一、Java 对象结构

Java对象（Object实例）结构包括三部分：对象头、对象体和对齐字节。

![img](assets/epub_38103745_29)

### 1、Java对象（Object实例）的三部分

#### （1）对象头

| 字段                        | 说明                                                         |
| --------------------------- | ------------------------------------------------------------ |
| Mark Word（标记字）         | 用于存储自身运行时的数据，例如GC标志位、哈希码，锁状态等信息。 |
| Class Pointer（类对象指针） | 用于存放方法区Class对象的地址，虚拟机通过这个指针来确定这个对象是那个类的实例。 |
| Array Length（数组长度）    | 如果对象是一个Java数组，那么此字段必须有，用于记录数组长度的数据；如果对象不是一个Java数组，那么次字段不存在，所有这是一个可选字段。 |

#### （2）对象体

对象体包含对象的实例变量（成员变量），用于成员属性值，包括父类的成员属性值。这部分内存按照4字节对齐。

#### （3）对齐字节

对齐字节也叫作填充对齐，其作用是用来保证Java对象所占内存字节数为8的倍数HotSpot VM的内存管理要求对象其实地址必须是8字节的整数倍。对象头本身是8的倍数，当对象的实例变量数据不是8的倍数时，便需要填充数据来保证8字节的对齐。

### 2、对象结构中核心字段的作用

| 字段                        | 说明                                                         |
| --------------------------- | ------------------------------------------------------------ |
| Mark Word（标记字）         | 用于表示对象的线程锁状态，另外还可以用来配合GC存放该对象的hashCode。 |
| Class Pointer（类对象指针） | 指向方法区中Class信息的指针，意味着该对象可随时知道自己是那个Class的实例。 |
| Array Length（数组长度）    | 占用32位（在32位JVM中）字节，这是可选的，只有当本对象是一个数组对象时才会有这个部分。 |
| 对象体                      | 用于保存对象属性值，是对象的主体部分，占用的内存空间大小取决于对象的属性数量和类型。 |
| 对齐字节                    | 并不是必然存在的，也没有特别的含义，它仅仅起着占位符的作用。当对象实例数据部分没有对齐（8字节的整数倍）时，就需要通过对齐填充来补全。 |

### 3、对象结构中的字段长度

Mark Word、Class Pointer、Array Length等字段的长度都与JVM的位数有关。Mark Word的长度为JVM的一个Word（字）大小，也就是说32位JVM的Mark Word为32位，64位JVM的Mark Word为64位。Class Pointer（类对象指针）字段的长度也为JVM的一个Word（字）大小，即32位JVM的Mark Word为32位，64位JVM的Mark Word为64位。

对于对象指针而言，如果JVM中的对象数量过多，使用64位的指针将浪费大量内存，通过简单统计，64位JVM将会比32位JVM多耗费50%的内存。为了节约内存可以使用选项+UseCompressedOops开启指针压缩。UseCompressedOops中的Oop为Ordinary object pointer（普通对象指针）的缩写。

如果开启UseCompressedOops选项，以下类型的指针将从64位压缩至32位：

- Class对象的属性指针（静态变量）。

- Object对象的属性指针（成员变量）。

- 普通对象数组的元素指针。

当然，也不是所有的指针都会压缩，一些特殊类型的指针不会压缩，比如指向PermGen（永久代）的Class对象指针（JDK 8中指向元空间的Class对象指针）、本地变量、堆栈元素、入参、返回值和NULL指针等。

在堆内存小于32GB的情况下，64位虚拟机的UseCompressedOops选项是默认开启的，该选项表示开启Oop对象的指针压缩会将原来64位的Oop对象指针压缩为32位。

手动开启Oop对象指针压缩的Java指令为：

```java
     java -XX:+UseCompressedOops mainclass
```

手动关闭Oop对象指针压缩的Java指令为：

```java
     java -XX:-UseCompressedOops mainclass
```

如果对象是一个数组，那么对象头还需要有额外的空间用于存储数组的长度（Array Length字段）。Array Length字段的长度也随着JVM架构的不同而不同：在32位JVM上，长度为32位；在64位JVM上，长度为64位。64位JVM如果开启了Oop对象的指针压缩，Array Length字段的长度也将由64位压缩至32位。

## 二、Mark Word的结构信息

Java内置锁涉及很多重要信息，这些都存放在对象结构中，并且存放于对象头的Mark Word字段中。

