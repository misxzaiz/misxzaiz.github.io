# 原子类型



## 一、实例

1. 使用原子整数（AtomicInteger）可以保证线程安全，而普通整数可能存在竞态条件的问题。
2. 同步计数器（CountDownLatch）用于等待所有线程完成后再输出结果。
3. 在多线程环境下，使用原子整数的 `incrementAndGet()` 方法可以确保线程安全地增加值。 
4. 普通整数的自增操作 `integer++` 不是线程安全的，可能导致结果不准确。 
5. 主线程通过调用 `latch.await()` 方法阻塞，直到所有线程完成。
6. 输出结果分别显示原子整数和普通整数的值。

```java
package org.example.demo.atomic;

import java.util.concurrent.CountDownLatch;
import java.util.concurrent.atomic.AtomicInteger;

public class Demo {
    
    public static final int THREAD_COUNT = 1000; // 线程数量
    static AtomicInteger atomicInteger = new AtomicInteger(0); // 使用原子整数，保证线程安全
    static Integer integer = new Integer(0); // 普通整数，在多线程环境下可能出现竞态条件
    static CountDownLatch latch; // 同步计数器，用于等待所有线程完成

    public static void main(String[] args) throws InterruptedException {
        latch = new CountDownLatch(THREAD_COUNT);
        for (int i = 0; i < THREAD_COUNT; i++) {
            new Thread(() -> {
                for (int i1 = 0; i1 < 1000; i1++) {
                    atomicInteger.incrementAndGet(); // 使用原子整数增加值，保证线程安全
                    integer++; // 非线程安全操作，可能导致结果不准确
                }
                latch.countDown(); // 完成一次迭代，线程计数器减一
            }).start();
        }
        // 阻塞主线程，直到线程计数器为零
        latch.await(); 
        System.out.println("Atomic Integer：" + atomicInteger.get()); // 输出原子整数的值
        System.out.println("Integer：" + integer); // 输出普通整数的值

    }
}
```

结果：

```java
Atomic Integer：1000000
Integer：517550
```

## 二、Atomic

原子类型是一种特殊的**数据类型**，提供了一种线程安全的方式来进行**并发访问**和**修改操作**。它们确保了多个线程之间的操作不会相互干扰或产生竞态条件。原子类型通常用于多线程环境下需要保证数据一致性和线程安全的场景。

以下是原子类型的主要特点和用途总结：

1. 线程安全：原子类型使用底层的硬件指令或锁机制来保证操作的原子性，从而避免了竞态条件和数据不一致的问题。
2. 原子操作：原子类型提供了一系列原子操作，例如增加、减少、赋值等，这些操作能够以原子方式执行，不会被其他线程中断或干扰。
3. 原子变量：原子类型通常包括**原子整数（AtomicInteger）**、**原子长整数（AtomicLong）**、**原子布尔型（AtomicBoolean）**等。它们提供了对应类型的原子操作和线程安全的访问方法。
4. 并发控制：原子类型可用于实现各种并发控制机制，如计数器、计时器、线程池等。使用原子类型可以避免显式地使用锁或同步块来实现线程安全。
5. 性能优化：原子类型通常比传统的同步机制更高效，因为它们使用了细粒度的锁或硬件指令，减少了线程间的争用和上下文切换。在并发负载较高的场景下，原子类型可以提供更好的性能。

总之，原子类型是一种重要的工具，用于处理多线程环境下的并发访问和修改。它们通过提供线程安全的操作和变量来简化并发编程，并确保数据的一致性和正确性。在设计多线程应用程序时，考虑使用原子类型可以提高程序的性能和可靠性。

## 三、AtomicInteger

### 1、属性

| 属性             | 类型   | 修饰                 | 说明               |
| ---------------- | ------ | -------------------- | ------------------ |
| serialVersionUID | long   | private static final | 序列化版本号       |
| unsafe           | Unsafe | private static final | 提供底层操作的对象 |
| valueOffset      | long   | private static final | 存储实际值的偏移量 |
| value            | int    | private **volatile** | 实际整数值         |

- serialVersionUID：AtomicInteger 类的序列化版本号。
- unsafe：提供了**底层操作的 Unsafe 对象**。Unsafe 是一个提供了访问底层内存和执行原子操作的类。
- valueOffset：存储实际整数值的内存偏移量。可以通过该偏移量直接访问和修改实际值。
- value：实际整数值，使用 volatile 修饰符来保证多线程环境下的可见性。

### 2、静态代码块

用于在类加载时初始化 `valueOffset` 属性。

首先，通过 `AtomicInteger.class.getDeclaredField("value")` 获取了 `AtomicInteger` 类中名为 "value" 的字段。`value` 字段是 `AtomicInteger` 类中存储实际整数值的属性。

然后，通过 `unsafe.objectFieldOffset()` 方法获取了该字段在内存中的偏移量，并将结果赋值给 `valueOffset` 属性。`unsafe.objectFieldOffset()` 方法是 `Unsafe` 类的方法，用于获取对象字段的内存偏移量。通过这个偏移量，可以直接访问和修改对象中的字段，而不需要通过对象实例的引用。

最后，在异常处理部分，如果获取字段或偏移量的过程中发生了异常，就抛出一个包含异常信息的 `Error` 对象。

总之，这段代码的作用是利用反射和 `Unsafe` 类来获取 `AtomicInteger` 类中存储整数值的字段的偏移量，并将偏移量保存到 `valueOffset` 属性中。这样，在后续的原子操作中可以**使用偏移量来直接访问和修改字段**，提高了性能和效率。

```java
    static {
        try {
            valueOffset = unsafe.objectFieldOffset
                (AtomicInteger.class.getDeclaredField("value"));
        } catch (Exception ex) { throw new Error(ex); }
    }
```

### 3、构造函数

| 构造函数                               | 说明                                  |
| -------------------------------------- | ------------------------------------- |
| public AtomicInteger(int initialValue) | 初始化并赋予value初始值为initialValue |
| public AtomicInteger()                 | value初始值为0                        |

### 4、方法

| 方法                  | 类型 | 修饰         | 说明         |
| --------------------- | ---- | ------------ | ------------ |
| set(int newValue)     | void | public final | 设置当前 `AtomicInteger` 对象的值为 `newValue`。 |
| lazySet(int newValue) | void | public final | 懒设置当前 `AtomicInteger` 对象的值为 `newValue`。该方法相比于 `set()` 方法不会立即写入主内存，因此可能对其他线程不可见，适用于对可见性要求不高的场景。 |
| getAndSet(int newValue) | int | public final | 获取并设置当前 `AtomicInteger` 对象的值为 `newValue`。返回设置前的旧值。 |
| compareAndSet(int expect, int update) | boolean | public final | 比较当前 `AtomicInteger` 对象的值与 `expect` 是否相等，如果相等，则将值设置为 `update`。如果成功设置，返回 `true`，否则返回 `false`。 |
| weakCompareAndSet(int expect, int update) | boolean | public final | 弱比较和设置方法。与 `compareAndSet()` 方法类似，但是在某些平台上，可能不保证原子性。 |
| getAndIncrement() | int | public final | 获取并将当前 `AtomicInteger` 对象的值加一。返回自增前的旧值。 |
| getAndDecrement() | int | public final | 获取并将当前 `AtomicInteger` 对象的值减一。返回自减前的旧值。 |
| getAndAdd(int delta) | int | public final | 获取并将当前 `AtomicInteger` 对象的值增加 `delta`。返回增加前的旧值。 |
| incrementAndGet() | int | public final | 将当前 `AtomicInteger` 对象的值加一，并返回自增后的新值。 |
| decrementAndGet() | int | public final | 将当前 `AtomicInteger` 对象的值减一，并返回自减后的新值。 |
| addAndGet(int delta) | int | public final | 将当前 `AtomicInteger` 对象的值增加 `delta`，并返回增加后的新值。 |
| getAndUpdate(IntUnaryOperator updateFunction) | int | public final | 先获取当前 `AtomicInteger` 对象的值，然后使用指定的 `updateFunction` 函数对该值进行更新，并返回更新前的旧值。 |
| updateAndGet(IntUnaryOperator updateFunction) | int | public final | 先使用指定的 `updateFunction` 函数对当前 `AtomicInteger` 对象的值进行更新，然后返回更新后的新值。 |
| getAndAccumulate(int x,                                  IntBinaryOperator accumulatorFunction) | int | public final | 先获取当前 `AtomicInteger` 对象的值，然后使用指定的 `accumulatorFunction` 函数将该值与 `x` 进行累加，并返回累加前的旧值。 |
| accumulateAndGet(int x,                                  IntBinaryOperator accumulatorFunction) | int | public final | 先使用指定的 `accumulatorFunction` 函数将当前 `AtomicInteger` 对象的值与 `x` 进行累加，然后返回累加后的新值。 |
| toString() | String | public | 将当前 `AtomicInteger` 对象的值转换为字符串形式，并返回结果。 |
| intValue() | int | public | 获取当前 `AtomicInteger` 对象的值，并将其转换为 `int` 类型后返回。 |
| longValue() | long | public | 获取当前 `AtomicInteger` 对象的值，并将其转换为 `long` 类型后返回。 |
| floatValue() | float | public | 获取当前 `AtomicInteger` 对象的值，并将其转换为 `float` 类型后返回。 |
| doubleValue() | double | public | 获取当前 `AtomicInteger` 对象的值，并将其转换为 `double` 类型后返回。 |

