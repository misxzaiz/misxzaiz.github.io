class p{constructor(){this.synthesis=window.speechSynthesis,this.recognition=null,this.ttsSupported="speechSynthesis"in window,this.sttSupported="webkitSpeechRecognition"in window||"SpeechRecognition"in window,this.ssmlSupported=this.ttsSupported,this.sttSupported&&this.initSpeechRecognition(),this.voiceProfiles={default:{lang:"zh-CN",pitch:1,rate:1,emotionLevel:0},taiwan:{lang:"zh-TW",pitch:1.1,rate:.9,emotionLevel:2,pitchVariation:.2,taiwaneseStyle:!0},neighborSister:{lang:"zh-CN",pitch:1.2,rate:.95,emotionLevel:1.5,pitchVariation:.15},gentle:{lang:"zh-CN",pitch:.9,rate:.85,emotionLevel:1,pitchVariation:.05},lively:{lang:"zh-CN",pitch:1.3,rate:1.1,emotionLevel:2,pitchVariation:.25}},this.currentVoiceProfile="default",this.taiwanesePatterns=[{pattern:/哎呀/g,ssml:'<say-as interpret-as="interjection">哎呀</say-as>'},{pattern:/诶/g,ssml:'<say-as interpret-as="interjection">诶</say-as>'},{pattern:/啊\s?/g,ssml:'<say-as interpret-as="interjection">啊</say-as>'},{pattern:/耶/g,ssml:'<say-as interpret-as="interjection">耶</say-as>'},{pattern:/唷/g,ssml:'<say-as interpret-as="interjection">唷</say-as>'},{pattern:/呢/g,ssml:'<say-as interpret-as="interjection">呢</say-as>'},{pattern:/喔/g,ssml:'<say-as interpret-as="interjection">喔</say-as>'},{pattern:/欸/g,ssml:'<say-as interpret-as="interjection">欸</say-as>'},{pattern:/啦$/g,ssml:'<emphasis level="strong">啦</emphasis>'},{pattern:/呀$/g,ssml:'<emphasis level="moderate">呀</emphasis>'},{pattern:/哦$/g,ssml:'<emphasis level="moderate">哦</emphasis>'},{pattern:/嘛$/g,ssml:'<emphasis level="moderate">嘛</emphasis>'},{pattern:/超(\w+)的/g,ssml:'超<emphasis level="strong">$1</emphasis>的'},{pattern:/好(\w+)哦/g,ssml:'好<emphasis level="strong">$1</emphasis>哦'}],this.emotionPatterns=[{pattern:/！/g,ssml:'<break time="0.2s"/><prosody pitch="+15%">!</prosody>'},{pattern:/\?/g,ssml:'<break time="0.1s"/><prosody pitch="+10%">?</prosody>'},{pattern:/～+/g,ssml:'<prosody pitch="+5%" rate="0.9">~</prosody>'},{pattern:/\.{3,}/g,ssml:'<break time="0.3s"/>'},{pattern:/喜欢|开心|高兴|快乐/g,ssml:'<prosody pitch="+10%" rate="1.1">$&</prosody>'},{pattern:/悲伤|难过|伤心|失望/g,ssml:'<prosody pitch="-10%" rate="0.9">$&</prosody>'},{pattern:/生气|愤怒|不满|烦躁/g,ssml:'<prosody pitch="+5%" rate="1.2">$&</prosody>'},{pattern:/惊讶|震惊|意外|吃惊/g,ssml:'<prosody pitch="+20%">$&</prosody>'}],this.recognitionActive=!1,this.recognitionRetries=0,this.maxRetries=3,this.recognitionLock=!1,this.recognitionTimeout=null}initSpeechRecognition(){try{const t=window.SpeechRecognition||window.webkitSpeechRecognition;if(!t){console.warn("浏览器不支持SpeechRecognition API"),this.sttSupported=!1;return}this.recognition=new t,this.recognition.continuous=!1,this.recognition.interimResults=!0,this.recognition.lang="zh-CN",this.recognition.onaudioend=()=>{if(this.recognitionActive&&this.recognitionRetries<this.maxRetries){console.log("音频输入结束，但识别仍在活动状态，尝试重新启动..."),this.recognitionRetries++;try{this.recognition.stop(),setTimeout(()=>{this.recognitionActive&&this.recognition.start()},300)}catch(e){console.error("重启语音识别失败:",e)}}}}catch(t){console.error("初始化语音识别失败:",t),this.sttSupported=!1}}async getVoices(){return this.ttsSupported?new Promise(t=>{let e=this.synthesis.getVoices();e.length?t(e):this.synthesis.onvoiceschanged=()=>{e=this.synthesis.getVoices(),t(e)}}):[]}getVoiceProfiles(){return this.voiceProfiles}setVoiceProfile(t){return this.voiceProfiles[t]?(this.currentVoiceProfile=t,!0):!1}getCurrentVoiceProfile(){return{name:this.currentVoiceProfile,...this.voiceProfiles[this.currentVoiceProfile]}}textToSSML(t){this.voiceProfiles[this.currentVoiceProfile];let e=t;return e=e.replace(/😊|😄|😀/g,""),e=e.replace(/😢|😭|😥/g,""),e=e.replace(/😮|😯|😲/g,""),e=e.replace(/🤔|🧐|🤓/g,""),e=e.replace(/[*_~`]/g," "),e}speak(t,e={}){return this.ttsSupported?new Promise((s,i)=>{try{this.synthesis.cancel();const o=this.ssmlSupported?this.textToSSML(t):t,n=new SpeechSynthesisUtterance(o),c=this.voiceProfiles[this.currentVoiceProfile];n.lang=e.lang||c.lang||"zh-CN",n.pitch=e.pitch||c.pitch||1,n.rate=e.rate||c.rate||1,n.volume=e.volume||1,e.voice?n.voice=e.voice:this.getVoices().then(h=>{const l=h.filter(r=>r.lang.indexOf(n.lang)===0);let a=null;c.name==="taiwan"?a=l.find(r=>r.lang.includes("TW")&&(r.name.includes("Female")||r.name.includes("女"))):(c.name.includes("Sister")||c.name==="gentle"||c.name==="lively")&&(a=l.find(r=>r.name.includes("Female")||r.name.includes("女"))),a||(a=l.find(r=>r.name.includes("Female")||r.name.includes("女"))),a&&(n.voice=a)}).catch(()=>{}),n.onend=()=>s(),n.onerror=h=>{h.error==="not-allowed"?i(new Error("语音合成错误: not-allowed - 需要用户交互才能播放语音")):i(new Error(`语音合成错误: ${h.error}`))},this.synthesis.speak(n)}catch(o){i(new Error(`语音合成初始化错误: ${o.message}`))}}):Promise.reject(new Error("浏览器不支持语音合成"))}startRecognition(t,e,s){if(!this.sttSupported||!this.recognition)return s&&s(new Error("浏览器不支持语音识别")),!1;if(this.recognitionLock)return console.warn("语音识别操作正在进行中，请稍后再试"),!1;if(this.recognitionLock=!0,this.recognitionTimeout&&(clearTimeout(this.recognitionTimeout),this.recognitionTimeout=null),this.recognitionActive||this.isRecognizing()){console.log("检测到语音识别已启动，先停止现有会话");try{this.recognitionActive=!1;try{this.recognition.abort()}catch{try{this.recognition.stop()}catch{}}return this.recognition.onresult=null,this.recognition.onerror=null,this.recognition.onend=null,this.recognitionTimeout=setTimeout(()=>{this.initSpeechRecognition(),this.recognitionLock=!1,this._startRecognitionProcess(t,e,s)},1e3),!0}catch(o){return console.error("停止现有语音识别失败:",o),this.recognitionLock=!1,s&&s(new Error(`停止现有语音识别失败: ${o.message}`)),!1}}const i=this._startRecognitionProcess(t,e,s);return this.recognitionLock=!1,i}_startRecognitionProcess(t,e,s){if(this.recognitionRetries=0,this.isRecognizing())return console.warn("语音识别已经启动，避免重复启动"),!1;this.recognitionActive=!0,this.recognition.onresult=i=>{if(!(!i.results||i.results.length===0))try{const o=i.results[0],n=o[0].transcript;o.isFinal?e&&e(n):t&&t(n)}catch(o){console.error("处理语音识别结果出错:",o)}},this.recognition.onerror=i=>{if(console.warn(`语音识别错误: ${i.error}`,i),i.error==="network"&&this.recognitionRetries<this.maxRetries){this.recognitionRetries++,console.log(`网络错误，尝试重新连接 (${this.recognitionRetries}/${this.maxRetries})...`),this.recognitionTimeout&&clearTimeout(this.recognitionTimeout),this.recognitionTimeout=setTimeout(()=>{if(this.recognitionActive)try{this.recognition.stop(),setTimeout(()=>{this.recognitionActive&&this.recognition.start()},500)}catch(o){console.error("重启语音识别失败:",o),s&&s(new Error(`语音识别重启失败: ${o.message}`)),this.recognitionActive=!1}},1e3);return}s&&s(new Error(`语音识别错误: ${i.error}`)),i.error!=="no-speech"&&(this.recognitionActive=!1)},this.recognition.onend=()=>{this.recognitionActive&&this.recognitionRetries<this.maxRetries?(console.log("语音识别意外结束，尝试重新启动..."),this.recognitionRetries++,this.recognitionTimeout&&clearTimeout(this.recognitionTimeout),this.recognitionTimeout=setTimeout(()=>{if(this.recognitionActive)try{this.recognition.start()}catch(i){console.error("重启语音识别失败:",i),s&&s(new Error(`语音识别重启失败: ${i.message}`)),this.recognitionActive=!1}},500)):this.recognitionActive=!1};try{return window.location.protocol!=="https:"&&window.location.hostname!=="localhost"&&window.location.hostname!=="127.0.0.1"&&console.warn("语音识别通常需要HTTPS安全上下文，当前环境可能不支持"),this.recognition.start(),!0}catch(i){return console.error("启动语音识别失败:",i),i.message&&i.message.includes("iframe")?s&&s(new Error("浏览器安全策略限制了语音识别功能，请尝试使用Chrome或Edge浏览器")):s&&s(new Error(`启动语音识别失败: ${i.message}`)),this.recognitionActive=!1,!1}}isRecognizing(){try{return!!(this.recognitionActive||this.recognition&&(this.recognition.recognizing||this.recognition.recognitionStarted||this.recognition.started))}catch{return!1}}stopRecognition(){if(!(!this.sttSupported||!this.recognition)){if(this.recognitionLock){console.warn("语音识别操作正在进行中，请稍后再试");return}this.recognitionLock=!0,this.recognitionTimeout&&(clearTimeout(this.recognitionTimeout),this.recognitionTimeout=null),this.recognitionActive=!1,this.recognitionRetries=0;try{try{this.recognition.abort()}catch{try{this.recognition.stop()}catch(e){console.warn("停止语音识别失败:",e)}}try{this.recognition.onresult=null,this.recognition.onerror=null,this.recognition.onend=null}catch{}setTimeout(()=>{this.recognitionLock=!1},500)}catch(t){console.warn("停止语音识别时出错:",t),this.recognitionLock=!1}}}isSpeaking(){return this.ttsSupported&&this.synthesis.speaking}stopSpeaking(){this.ttsSupported&&this.synthesis.cancel()}}export{p as V};
