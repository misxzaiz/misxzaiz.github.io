class p{constructor(){this.synthesis=window.speechSynthesis,this.recognition=null,this.ttsSupported="speechSynthesis"in window,this.sttSupported="webkitSpeechRecognition"in window||"SpeechRecognition"in window,this.ssmlSupported=this.ttsSupported,this.sttSupported&&this.initSpeechRecognition(),this.voiceProfiles={default:{lang:"zh-CN",pitch:1,rate:1,emotionLevel:0},taiwan:{lang:"zh-TW",pitch:1.1,rate:.9,emotionLevel:2,pitchVariation:.2,taiwaneseStyle:!0},neighborSister:{lang:"zh-CN",pitch:1.2,rate:.95,emotionLevel:1.5,pitchVariation:.15},gentle:{lang:"zh-CN",pitch:.9,rate:.85,emotionLevel:1,pitchVariation:.05},lively:{lang:"zh-CN",pitch:1.3,rate:1.1,emotionLevel:2,pitchVariation:.25}},this.currentVoiceProfile="default",this.taiwanesePatterns=[{pattern:/å“å‘€/g,ssml:'<say-as interpret-as="interjection">å“å‘€</say-as>'},{pattern:/è¯¶/g,ssml:'<say-as interpret-as="interjection">è¯¶</say-as>'},{pattern:/å•Š\s?/g,ssml:'<say-as interpret-as="interjection">å•Š</say-as>'},{pattern:/è€¶/g,ssml:'<say-as interpret-as="interjection">è€¶</say-as>'},{pattern:/å”·/g,ssml:'<say-as interpret-as="interjection">å”·</say-as>'},{pattern:/å‘¢/g,ssml:'<say-as interpret-as="interjection">å‘¢</say-as>'},{pattern:/å–”/g,ssml:'<say-as interpret-as="interjection">å–”</say-as>'},{pattern:/æ¬¸/g,ssml:'<say-as interpret-as="interjection">æ¬¸</say-as>'},{pattern:/å•¦$/g,ssml:'<emphasis level="strong">å•¦</emphasis>'},{pattern:/å‘€$/g,ssml:'<emphasis level="moderate">å‘€</emphasis>'},{pattern:/å“¦$/g,ssml:'<emphasis level="moderate">å“¦</emphasis>'},{pattern:/å˜›$/g,ssml:'<emphasis level="moderate">å˜›</emphasis>'},{pattern:/è¶…(\w+)çš„/g,ssml:'è¶…<emphasis level="strong">$1</emphasis>çš„'},{pattern:/å¥½(\w+)å“¦/g,ssml:'å¥½<emphasis level="strong">$1</emphasis>å“¦'}],this.emotionPatterns=[{pattern:/ï¼/g,ssml:'<break time="0.2s"/><prosody pitch="+15%">!</prosody>'},{pattern:/\?/g,ssml:'<break time="0.1s"/><prosody pitch="+10%">?</prosody>'},{pattern:/ï½+/g,ssml:'<prosody pitch="+5%" rate="0.9">~</prosody>'},{pattern:/\.{3,}/g,ssml:'<break time="0.3s"/>'},{pattern:/å–œæ¬¢|å¼€å¿ƒ|é«˜å…´|å¿«ä¹/g,ssml:'<prosody pitch="+10%" rate="1.1">$&</prosody>'},{pattern:/æ‚²ä¼¤|éš¾è¿‡|ä¼¤å¿ƒ|å¤±æœ›/g,ssml:'<prosody pitch="-10%" rate="0.9">$&</prosody>'},{pattern:/ç”Ÿæ°”|æ„¤æ€’|ä¸æ»¡|çƒ¦èº/g,ssml:'<prosody pitch="+5%" rate="1.2">$&</prosody>'},{pattern:/æƒŠè®¶|éœ‡æƒŠ|æ„å¤–|åƒæƒŠ/g,ssml:'<prosody pitch="+20%">$&</prosody>'}],this.recognitionActive=!1,this.recognitionRetries=0,this.maxRetries=3,this.recognitionLock=!1,this.recognitionTimeout=null}initSpeechRecognition(){try{const t=window.SpeechRecognition||window.webkitSpeechRecognition;if(!t){console.warn("æµè§ˆå™¨ä¸æ”¯æŒSpeechRecognition API"),this.sttSupported=!1;return}this.recognition=new t,this.recognition.continuous=!1,this.recognition.interimResults=!0,this.recognition.lang="zh-CN",this.recognition.onaudioend=()=>{if(this.recognitionActive&&this.recognitionRetries<this.maxRetries){console.log("éŸ³é¢‘è¾“å…¥ç»“æŸï¼Œä½†è¯†åˆ«ä»åœ¨æ´»åŠ¨çŠ¶æ€ï¼Œå°è¯•é‡æ–°å¯åŠ¨..."),this.recognitionRetries++;try{this.recognition.stop(),setTimeout(()=>{this.recognitionActive&&this.recognition.start()},300)}catch(e){console.error("é‡å¯è¯­éŸ³è¯†åˆ«å¤±è´¥:",e)}}}}catch(t){console.error("åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«å¤±è´¥:",t),this.sttSupported=!1}}async getVoices(){return this.ttsSupported?new Promise(t=>{let e=this.synthesis.getVoices();e.length?t(e):this.synthesis.onvoiceschanged=()=>{e=this.synthesis.getVoices(),t(e)}}):[]}getVoiceProfiles(){return this.voiceProfiles}setVoiceProfile(t){return this.voiceProfiles[t]?(this.currentVoiceProfile=t,!0):!1}getCurrentVoiceProfile(){return{name:this.currentVoiceProfile,...this.voiceProfiles[this.currentVoiceProfile]}}textToSSML(t){this.voiceProfiles[this.currentVoiceProfile];let e=t;return e=e.replace(/ğŸ˜Š|ğŸ˜„|ğŸ˜€/g,""),e=e.replace(/ğŸ˜¢|ğŸ˜­|ğŸ˜¥/g,""),e=e.replace(/ğŸ˜®|ğŸ˜¯|ğŸ˜²/g,""),e=e.replace(/ğŸ¤”|ğŸ§|ğŸ¤“/g,""),e=e.replace(/[*_~`]/g," "),e}speak(t,e={}){return this.ttsSupported?new Promise((s,i)=>{try{this.synthesis.cancel();const o=this.ssmlSupported?this.textToSSML(t):t,n=new SpeechSynthesisUtterance(o),c=this.voiceProfiles[this.currentVoiceProfile];n.lang=e.lang||c.lang||"zh-CN",n.pitch=e.pitch||c.pitch||1,n.rate=e.rate||c.rate||1,n.volume=e.volume||1,e.voice?n.voice=e.voice:this.getVoices().then(h=>{const l=h.filter(r=>r.lang.indexOf(n.lang)===0);let a=null;c.name==="taiwan"?a=l.find(r=>r.lang.includes("TW")&&(r.name.includes("Female")||r.name.includes("å¥³"))):(c.name.includes("Sister")||c.name==="gentle"||c.name==="lively")&&(a=l.find(r=>r.name.includes("Female")||r.name.includes("å¥³"))),a||(a=l.find(r=>r.name.includes("Female")||r.name.includes("å¥³"))),a&&(n.voice=a)}).catch(()=>{}),n.onend=()=>s(),n.onerror=h=>{h.error==="not-allowed"?i(new Error("è¯­éŸ³åˆæˆé”™è¯¯: not-allowed - éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾è¯­éŸ³")):i(new Error(`è¯­éŸ³åˆæˆé”™è¯¯: ${h.error}`))},this.synthesis.speak(n)}catch(o){i(new Error(`è¯­éŸ³åˆæˆåˆå§‹åŒ–é”™è¯¯: ${o.message}`))}}):Promise.reject(new Error("æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ"))}startRecognition(t,e,s){if(!this.sttSupported||!this.recognition)return s&&s(new Error("æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«")),!1;if(this.recognitionLock)return console.warn("è¯­éŸ³è¯†åˆ«æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨åå†è¯•"),!1;if(this.recognitionLock=!0,this.recognitionTimeout&&(clearTimeout(this.recognitionTimeout),this.recognitionTimeout=null),this.recognitionActive||this.isRecognizing()){console.log("æ£€æµ‹åˆ°è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨ï¼Œå…ˆåœæ­¢ç°æœ‰ä¼šè¯");try{this.recognitionActive=!1;try{this.recognition.abort()}catch{try{this.recognition.stop()}catch{}}return this.recognition.onresult=null,this.recognition.onerror=null,this.recognition.onend=null,this.recognitionTimeout=setTimeout(()=>{this.initSpeechRecognition(),this.recognitionLock=!1,this._startRecognitionProcess(t,e,s)},1e3),!0}catch(o){return console.error("åœæ­¢ç°æœ‰è¯­éŸ³è¯†åˆ«å¤±è´¥:",o),this.recognitionLock=!1,s&&s(new Error(`åœæ­¢ç°æœ‰è¯­éŸ³è¯†åˆ«å¤±è´¥: ${o.message}`)),!1}}const i=this._startRecognitionProcess(t,e,s);return this.recognitionLock=!1,i}_startRecognitionProcess(t,e,s){if(this.recognitionRetries=0,this.isRecognizing())return console.warn("è¯­éŸ³è¯†åˆ«å·²ç»å¯åŠ¨ï¼Œé¿å…é‡å¤å¯åŠ¨"),!1;this.recognitionActive=!0,this.recognition.onresult=i=>{if(!(!i.results||i.results.length===0))try{const o=i.results[0],n=o[0].transcript;o.isFinal?e&&e(n):t&&t(n)}catch(o){console.error("å¤„ç†è¯­éŸ³è¯†åˆ«ç»“æœå‡ºé”™:",o)}},this.recognition.onerror=i=>{if(console.warn(`è¯­éŸ³è¯†åˆ«é”™è¯¯: ${i.error}`,i),i.error==="network"&&this.recognitionRetries<this.maxRetries){this.recognitionRetries++,console.log(`ç½‘ç»œé”™è¯¯ï¼Œå°è¯•é‡æ–°è¿æ¥ (${this.recognitionRetries}/${this.maxRetries})...`),this.recognitionTimeout&&clearTimeout(this.recognitionTimeout),this.recognitionTimeout=setTimeout(()=>{if(this.recognitionActive)try{this.recognition.stop(),setTimeout(()=>{this.recognitionActive&&this.recognition.start()},500)}catch(o){console.error("é‡å¯è¯­éŸ³è¯†åˆ«å¤±è´¥:",o),s&&s(new Error(`è¯­éŸ³è¯†åˆ«é‡å¯å¤±è´¥: ${o.message}`)),this.recognitionActive=!1}},1e3);return}s&&s(new Error(`è¯­éŸ³è¯†åˆ«é”™è¯¯: ${i.error}`)),i.error!=="no-speech"&&(this.recognitionActive=!1)},this.recognition.onend=()=>{this.recognitionActive&&this.recognitionRetries<this.maxRetries?(console.log("è¯­éŸ³è¯†åˆ«æ„å¤–ç»“æŸï¼Œå°è¯•é‡æ–°å¯åŠ¨..."),this.recognitionRetries++,this.recognitionTimeout&&clearTimeout(this.recognitionTimeout),this.recognitionTimeout=setTimeout(()=>{if(this.recognitionActive)try{this.recognition.start()}catch(i){console.error("é‡å¯è¯­éŸ³è¯†åˆ«å¤±è´¥:",i),s&&s(new Error(`è¯­éŸ³è¯†åˆ«é‡å¯å¤±è´¥: ${i.message}`)),this.recognitionActive=!1}},500)):this.recognitionActive=!1};try{return window.location.protocol!=="https:"&&window.location.hostname!=="localhost"&&window.location.hostname!=="127.0.0.1"&&console.warn("è¯­éŸ³è¯†åˆ«é€šå¸¸éœ€è¦HTTPSå®‰å…¨ä¸Šä¸‹æ–‡ï¼Œå½“å‰ç¯å¢ƒå¯èƒ½ä¸æ”¯æŒ"),this.recognition.start(),!0}catch(i){return console.error("å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥:",i),i.message&&i.message.includes("iframe")?s&&s(new Error("æµè§ˆå™¨å®‰å…¨ç­–ç•¥é™åˆ¶äº†è¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼Œè¯·å°è¯•ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨")):s&&s(new Error(`å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥: ${i.message}`)),this.recognitionActive=!1,!1}}isRecognizing(){try{return!!(this.recognitionActive||this.recognition&&(this.recognition.recognizing||this.recognition.recognitionStarted||this.recognition.started))}catch{return!1}}stopRecognition(){if(!(!this.sttSupported||!this.recognition)){if(this.recognitionLock){console.warn("è¯­éŸ³è¯†åˆ«æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨åå†è¯•");return}this.recognitionLock=!0,this.recognitionTimeout&&(clearTimeout(this.recognitionTimeout),this.recognitionTimeout=null),this.recognitionActive=!1,this.recognitionRetries=0;try{try{this.recognition.abort()}catch{try{this.recognition.stop()}catch(e){console.warn("åœæ­¢è¯­éŸ³è¯†åˆ«å¤±è´¥:",e)}}try{this.recognition.onresult=null,this.recognition.onerror=null,this.recognition.onend=null}catch{}setTimeout(()=>{this.recognitionLock=!1},500)}catch(t){console.warn("åœæ­¢è¯­éŸ³è¯†åˆ«æ—¶å‡ºé”™:",t),this.recognitionLock=!1}}}isSpeaking(){return this.ttsSupported&&this.synthesis.speaking}stopSpeaking(){this.ttsSupported&&this.synthesis.cancel()}}export{p as V};
