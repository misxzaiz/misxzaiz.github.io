import{_ as z,a as i,j as L,b as c,o as d,d as o,e as k,F as O,h as $,n as N,t as q,f as D,v as I,m as K,p as y,z as S,q as W}from"./index-D43yhpX6.js";import{V as j}from"./VoiceService-DKBGZCSk.js";const E={class:"chat-window"},F={class:"bubble"},J={key:0,class:"msg assistant"},A={key:0,class:"recognized-text"},P=["disabled","onKeydown"],U=["disabled","title"],X=["disabled"],G={key:1,class:"voice-support-warning"},Q={__name:"ChatWindow",props:{apikey:String},setup(g,{expose:T}){const C=g,v=i([{role:"assistant",content:"你好！😊 很高兴见到你～ 有什么我可以帮你的？"}]),r=i(""),n=i(!1),m=i(null),p=i(null),u=i(!1),l=i(!1),t=i("");L(()=>{try{p.value=new j,u.value=p.value.sttSupported,console.log("语音识别支持状态:",u.value)}catch(a){console.error("初始化语音服务失败:",a),u.value=!1}});function M(){if(!(!p.value||!u.value||n.value)){l.value=!0,t.value="";try{p.value.startRecognition(a=>{t.value=a,h()},a=>{t.value=a},a=>{console.error("语音识别错误:",a),l.value=!1,t.value=""})}catch(a){console.error("启动语音识别失败:",a),l.value=!1}}}function b(){l.value&&(p.value?.stopRecognition(),l.value=!1,t.value.trim()&&(r.value=t.value,t.value="",x()))}async function x(){if(!r.value.trim()&&!t.value.trim()||n.value)return;const a=r.value.trim()||t.value.trim();v.value.push({role:"user",content:a}),n.value=!0,await S(),h(),r.value="",t.value="";let s={role:"assistant",content:""};v.value.push(s);try{const e=new XMLHttpRequest;e.open("POST","https://api.deepseek.com/chat/completions",!0),e.setRequestHeader("Authorization",`Bearer ${C.apikey}`),e.setRequestHeader("Content-Type","application/json");let _=0;e.onreadystatechange=function(){if(e.readyState===3||e.readyState===4){const f=e.responseText,B=f.slice(_);_=f.length;const H=B.split(`
`);for(const R of H)if(R.startsWith("data: ")){const V=R.slice(6);if(V==="[DONE]"){n.value=!1,h();return}try{const w=JSON.parse(V);w.choices&&w.choices[0]?.delta?.content&&(s.content+=w.choices[0].delta.content,S(h))}catch{}}}e.readyState===4&&e.status!==200&&(s.content="❌ 出错了，请重试。",n.value=!1)},e.send(JSON.stringify({model:"deepseek-chat",messages:v.value.map(f=>({role:f.role,content:f.content})),stream:!0}))}catch{s.content="❌ 出错了，请重试。",n.value=!1}}function h(){S(()=>{m.value&&(m.value.scrollTop=m.value.scrollHeight)})}return T({messages:v}),(a,s)=>(d(),c("div",E,[o("div",{class:"messages",ref_key:"msgList",ref:m},[(d(!0),c(O,null,$(v.value,(e,_)=>(d(),c("div",{key:_,class:N(["msg",e.role])},[o("div",F,q(e.content),1)],2))),128)),n.value?(d(),c("div",J,s[2]||(s[2]=[o("div",{class:"bubble loading"},[o("span",{class:"dot"}),o("span",{class:"dot"}),o("span",{class:"dot"})],-1)]))):k("",!0)],512),t.value?(d(),c("div",A," 正在识别: "+q(t.value),1)):k("",!0),o("form",{class:"input-bar",onSubmit:y(x,["prevent"])},[D(o("input",{"onUpdate:modelValue":s[0]||(s[0]=e=>r.value=e),disabled:n.value||l.value,placeholder:"请输入内容…",onKeydown:K(y(x,["exact","prevent"]),["enter"])},null,40,P),[[I,r.value]]),o("button",{type:"button",class:N(["voice-button",{recording:l.value}]),onMousedown:M,onMouseup:b,onMouseleave:s[1]||(s[1]=e=>l.value?b():null),onTouchstart:y(M,["prevent"]),onTouchend:y(b,["prevent"]),disabled:n.value||!u.value,title:u.value?"按住说话":"浏览器不支持语音识别"},s[3]||(s[3]=[o("span",{class:"voice-icon"},"🎤",-1)]),42,U),o("button",{disabled:!r.value.trim()&&!t.value.trim()||n.value,type:"submit"},"➤",8,X)],32),u.value?k("",!0):(d(),c("div",G," ⚠️ 您的浏览器不支持语音识别 "))]))}},Y=z(Q,[["__scopeId","data-v-aa9739a9"]]),Z={class:"text-chat-container"},ee={__name:"TextChatView",props:{apikey:{type:String,required:!0}},setup(g){return(T,C)=>(d(),c("div",Z,[W(Y,{apikey:g.apikey},null,8,["apikey"])]))}},ae=z(ee,[["__scopeId","data-v-50513fe3"]]);export{ae as default};
