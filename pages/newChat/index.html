<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="../../css/element.css" />
    <script src="../../js/vue@3.js"></script>
    <script src="../../js/element-plus.js"></script>
    <script src="../../js/axios.min.js"></script>
    <script src="../../index.js"></script>
    <script src="../../module/interfaceacting220819.js"></script>
    <script src="../../module/antidomxss_v640.js"></script>
    <script src="../module/footer.js"></script>
    <link rel="stylesheet" href="../../css/main.css">
    <style>
        #chatbox {
            width: 400px;
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
        }
    </style>
</head>

<body>

    <div id="app">
        <div style="margin-bottom: 3%;">
            <el-button @click="goBack">返回</el-button>
            <el-button @click="getAddList()">新朋友</el-button>
        </div>
        
        <div>
            <el-tabs tab-position="left" class="demo-tabs" v-model="activeTab">
                <div v-for="(item, index) in friendList" :key="index">
                    <el-tab-pane :label="item.tuid" :name="item.tuid">
                        <input type="text" v-model="message" placeholder="输入内容...">
                        <button @click="sendMessage(item.tuid)">发送</button>
                        <div v-for="(item1, index1) in item.messages" :key="index1">
                            <div v-if="item1[0] == 'ME'" style="color: red;">
                                {{item1[0]}} : {{item1[1]}}
                            </div>
                            <div v-else>
                                {{item1[0]}} : {{item1[1]}}
                            </div>
                        </div>
                    </el-tab-pane>
                </div>
            </el-tabs>

            <!-- {{friendList}} -->
        </div>
        <el-drawer v-model="drawer" title="新朋友" direction="btt" size="70%">
            <div v-for="item,index in addList" :key="item.id">
                <el-card :body-style="{ padding: '0px' }">
                    <div style="padding: 14px">
                      <div class="bottom">
                        <time class="time">uid：{{item.tuid}}</time>
                        <el-button type="primary" class="button" @click="href('../user/show-user.html?id='+item.tuid)">资料</el-button>
                        <el-button type="primary" class="button" @click="agree(item.tuid)">同意</el-button>
                        <!-- <el-button class="button">拒绝</el-button> -->
                      </div>
                    </div>
                </el-card>
            </div>
        </el-drawer>
        <foot-bar :active-btn="3"></foot-bar>
    </div>

    <script>
        const App = {
            data() {
                return {
                    activeTab: null,
                    socket: null,
                    message: null,
                    MyPhone: null,
                    MyUid: null,
                    phone: null,
                    sendMsg: {
                        uid: null,
                        message: null
                    },
                    friendList: [
                        {
                            uid: 1,
                            messages: [["ME","MSG"]]
                        }
                    ],
                }
            },
            created() {
                this.getMyFriend()
                this.setBase()
                this.connectWebSocket()
            },
            methods: {
                goBack() {
                    window.history.back();
                },
                getAddList() {
                    this.drawer = true
                    axios.get("/web/user-friend/getAddList")
                        .then(res => {
                            // this.$message.success(res.data.message)
                            if(res.data.code==200){
                                this.addList = res.data.data
                                // this.$message.success(res.data.message)
                            } else {
                                this.$message.error(res.data.message)
                            }
                        })
                        .catch(err => {
                            console.log(err);
                            this.$message.error(err)
                        });
                },
                agree(tuid) {
                    axios.get("/web/user-friend/agree/"+tuid)
                        .then(res => {
                            // this.$message.success(res.data.message)
                            if(res.data.code==200){
                                this.$message.success(res.data.message)
                            } else {
                                this.$message.error(res.data.message)
                            }
                        })
                        .catch(err => {
                            console.log(err);
                            this.$message.error(err)
                        });
                },
                href(url) {
                    window.location.href = url
                },
                getUserList() {
                    axios.get("/web/user/list")
                        .then(res => {
                            this.friendList = res.data.data
                        })
                        .catch(err => {
                            console.log(err);
                            this.$message.error(err)
                        });
                        
                },
                getMyFriend() {
                    axios.get("/web/user-friend/getUserFriendList")
                        .then(res => {
                            this.friendList = res.data.data
                            // this.$message.success(res.data.message)
                        })
                        .catch(err => {
                            console.log(err);
                            this.$message.error(err)
                        });
                },
                connectWebSocket() {
                    this.isOnline = false
                    console.log("connectWebSocket")
                    console.log(this.MyUid)
                    // 创建WebSocket连接
                    // webSocketUri 在 index.js 文件中定义   
                    this.socket = new WebSocket(`ws://${webSocketUri}/websocket/chat?token=${token}`);
                    // 在连接打开时触发的事件
                    this.socket.onopen = () => { console.log("Connected to server"); };
                    // 在接收到消息时触发的事件
                    this.socket.onmessage = (event) => {
                        const message = event.data;
                        const [uid, msg] = message.split(",");
                        for(var i = 0; i < this.friendList.length ; i++){
                            console.log("uid："+this.friendList[i].uid)
                            if(this.friendList[i].tuid == uid) {
                                if(this.friendList[i].messages==null){
                                    this.friendList[i].messages = [["HE",msg]]
                                }else {
                                    this.friendList[i].messages.push(["HE",msg])
                                }
                                break;
                            }
                        }
                    };
                },
                sendMessage(uid) {
                    this.uid = uid;
                    console.log("sendMessage")
                    console.log(this.uid)
                    this.sendMsg = {
                        tid: this.uid,
                        message: this.message
                    }
                    this.socket.send(JSON.stringify(this.sendMsg));
                    console.log("length："+this.friendList.length)
                    for(var i = 0; i < this.friendList.length ; i++){
                        console.log("uid："+this.friendList[i].uid)
                        if(this.friendList[i].tuid == uid) {
                            if(this.friendList[i].messages==null){
                                this.friendList[i].messages = [["ME",this.message]]
                            }else {
                                this.friendList[i].messages.push(["ME",this.message])
                            }
                            break;
                        }
                    }
                },
                setBase() {
                    // userDto 在 index.js 文件中定义
                    this.MyPhone = userDto.phone
                    this.MyUid = userDto.uid
                    var searchParams = new URLSearchParams(location.search);
                    this.activeTab = searchParams.has('id') ? searchParams.get('id') : this.MyUid;
                }
            },
            mounted() {

            }
        };
        const app = Vue.createApp(App);
        app.use(ElementPlus);
        app.component('foot-bar', footBarComponent);
        app.mount("#app");
    </script>
</body>

</html>